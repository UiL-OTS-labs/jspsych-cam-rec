<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">
    
    <title>Babies Online (not in the basement) </title>

    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/jspsych.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-html-button-response.js"></script>
    
    <!-- Audio playback &response libraries (audio) -->
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-audio-button-response.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>

    <!-- Video -->
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-video-keyboard-response.js"></script>
    <!-- External HTML for Maaike's (osweb) file -->
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-external-html.js"></script>
    
    <!-- preload media (new plugin since 6.3?) -->
<!--     <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-preload.js"></script>
 -->

    <!-- Generic check/ask libraries (instructions & surveys) -->
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-survey-html-form.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-survey-multi-select.js"></script>
    
    <!--this was originally used (with a hack to get white table) borders (now in GRID_HTML) -->
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-vsl-grid-scene.js"></script>

    <!-- Generic jspsych style sheet -->
    <link href="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"/>

    <!-- UU fonts -->
    <link href=https://web-experiments.lab.hum.uu.nl/jspsych/uil-utils/0.0/fonts.css rel="stylesheet" type="text/css"/>

    <!-- VSL-grid plugin (copied a version with white table layout for testing)-->
<!--     <script src="plugin/jspsych-vsl-grid-scene-white.js"></script>
 -->    
    <!-- Uil OTS libraries -->
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/uil-utils/0.0/jspsych-uil-utils.js"></script>

     <!-- Uil OTS organised  -->
    <script src="stimuli.js"></script>
    <script src="globals.js"></script>
    <script src="instructions.js"></script>
    <script src="soundtest.js"></script>
    <script src="consent.js"></script>
    <script src="survey.js"></script>

    <style>

    .instruction {
        text-align: left;
        margin: 5% 10% 5% 10%;
    }


    kbd {
        border-radius: 2px;
        padding: 2px;
        border: 1px solid black;
    }

        /* UU-like Link styles */
    a {
        color: rgb(33, 37, 41);
        text-decoration: underline;
        transition: 0.2s ease color;
    }

    a:hover {
        transition: 0.2s ease color;
        color: rgb(85, 85, 95);
    }

    span::after {
        padding-left: 1%;
    }

    /* survey layout text-align */

    .survey {
        text-align: left !important;
    }

    .jspsych-survey-html-form {
        text-align: left !important;
    }

    .jspsych-survey-multi-choice-question {
        text-align: left !important;
    }

    .jspsych-survey-multi-choice-horizontal {
        text-align: left !important;
    }

    .jspsych-survey-multi-choice-text {
        text-align: left !important;
    }

    .jspsych-survey-multi-choice-option {
        text-align: left !important;
    }

    /* valid input feedback (survey) */ 

    input:invalid + span::after {
        content: '✖';
    }

    input:valid+span::after {
        content: '✓';
    }

    </style>
    </head>
    <body></body>
    <script>
    
    // Wait until the browser has loaded all files, then execute the
    // contents of this method
    window.addEventListener('load', function() {



        // load stimuli

        let baseline_items = getBaselineItems().table;
        console.log(baseline_items);
        
        let paired_items = getPairedItems().table;
        console.log(paired_items);

        let grabber_items_one = getGrabberOneItems().table;
        console.log(grabber_items_one);

        let grabber_items_two = getGrabberTwoItems().table;
        console.log(grabber_items_two);

        ////////////////////////// media preloading ///////////////////////////////////////
        

        // BASELINE
        var baseline_audio = [];
        for (var i=0; i< baseline_items.length; i++) {
            baseline_audio.push(baseline_items[i].sound_fn);
            console.log('loaded baseline audio as "baseline_audio"');
        };

        var baseline_videos = [];
        for (var i=0; i< baseline_items.length; i++) {
            baseline_videos.push(baseline_items[i].image_fn + ".mp4");
            baseline_videos.push(baseline_items[i].image_fn + ".webm");
            console.log('loaded baseline video as "baseline_videos"');
        };
                
        // PAIRED
        var paired_audio = [];
        for (var i=0; i< paired_items.length; i++) {
            paired_audio.push(paired_items[i].sound_fn);
            console.log('loaded paired succesion audio as "paired_audio"');
        };

        var paired_videos = [];
        for (var i=0; i< paired_items.length; i++) {
            paired_videos.push(paired_items[i].image_fn[0]);
            paired_videos.push(paired_items[i].image_fn[1]);

            console.log('loaded baseline video as "baseline_videos"');
        };
        
        // GRABBER
        var grabber_audio_one = [];
        for (var i=0; i< grabber_items_one.length; i++) {
            grabber_audio_one.push(grabber_items_one[i].sound_fn);
            console.log('loaded grabber one audio as "grabber_audio_one"');
        };

        var grabber_video_one = [];
        for (var i=0; i< grabber_items_one.length; i++) {
            grabber_video_one.push(grabber_items_one[i].image_fn + ".mp4");
            grabber_video_one.push(grabber_items_one[i].image_fn + ".webm");
            console.log('loaded grabber one video as "grabber_video_one"');
        };

        var grabber_audio_two = [];
        for (var i=0; i< grabber_items_two.length; i++) {
            grabber_audio_two.push(grabber_items_two[i].sound_fn);
            console.log('loaded grabber two audio as "grabber_audio_two"');
        };

        var grabber_video_two= [];
        for (var i=0; i< grabber_items_two.length; i++) {
            grabber_video_two.push(grabber_items_two[i].image_fn + ".mp4");
            grabber_video_two.push(grabber_items_two[i].image_fn + ".webm");
            console.log('loaded grabber two video as "grabber_video_two"');
        };
        
        console.log('_________________');
        console.log(grabber_video_one);
        console.log(grabber_video_two);

        // add scources to videos:
        //https://stackoverflow.com/questions/9923573/replacing-html5-video-src-strings-in-javascript-does-not-replace-video

        function add_source(element, src, type) {
            var source = document.createElement("source");
            source.src = src;
            source.type = type;
            element.appendChild(source);
        }
        // change background styles

        function set_html_to_grey() {
            document.body.style.backgroundColor = GREY_HEX; // background color
            document.body.style.color = 'black' // font color
        }

        function set_html_to_white() {
            document.body.style.backgroundColor = 'white'
            document.body.style.color = 'black'
        }

        // TEST SOUND
        var check_audio = ['./sounds/testtune.mp3'];
        var check_qrvideo = ['./video/qrcodes/qrspeed.mp4','./video/qrcodes/qrspeed.webm'];
        var bgvideo = [
            './video/01_left.mp4',
            './video/01_left.webm',
            './video/02_center.mp4',
            './video/02_center.webm',
            './video/03_right.mp4',
            './video/03_right.webm'
        ];
        console.log(bgvideo);


        // Data one would like to add to __all__ trials, according to:
        // https://www.jspsych.org/overview/data/
        
        let subject_id = jsPsych.randomization.randomID(8);

        jsPsych.data.addProperties({
            subject: subject_id
        });

        // screens/(sub-)(trial-)phases...////////////////////////////////////////////////////

        let start_screen = {
            type: 'html-button-response',
            stimulus: function(){
                return "<div class='instruction' >" +
                       "<p>" + GENERIC_CHECK + "</p></div>";
            },
            choices: [OK_BUTTON_TEXT],
            response_ends_trial: true
        };

        let instruction_screen_layout = {
            type: 'html-button-response',
            stimulus: function(){
                let text = PRE_LAYOUT_MESSAGE;
                return "<div class='instruction' >" +
                       "<p>" + text + "</p></div>";
            },
            choices: [OK_BUTTON_TEXT],
            response_ends_trial: true,
        };

        let check_screen_layout = {
            type: 'html-button-response',
            stimulus: function(){
                let table = GRID_HTML_LAYOUT;
                return table;
            },
            choices: ["Continue"],
            response_ends_trial: true,
        };

        let instruction_screen_rec = {
            type: 'html-button-response',
            stimulus: function(){
                let text = PRE_REC_MESSAGE;
                return "<div class='instruction' >" +
                       "<p>" + text + "</p></div>";
            },
            choices: [OK_BUTTON_TEXT],
            response_ends_trial: true,
        };

        let left_and_right_screen = {
            type: 'audio-button-response',
            on_start: set_html_to_grey,
            stimulus: jsPsych.timelineVariable('sound_fn'),
            prompt: function() {
                
                var grid = GRID_HTML_LEFT_RIGHT

                var gridleft = grid.replaceAll("./video/01_left",
                        jsPsych.timelineVariable('image_fn_left'));

                var gridright = gridleft.replaceAll("./video/03_right",
                        jsPsych.timelineVariable('image_fn_right'));

                console.log(gridright);
                return gridright;
            },
            response_ends_trial: false,
            trial_ends_after_audio: false,
            trial_duration: 2950,
            choices: [],
            on_finish: set_html_to_white,
            data: {
                target_audio: jsPsych.timelineVariable('sound_fn'),
                target_image_a: jsPsych.timelineVariable('image_fn_left'),
                target_image_b: jsPsych.timelineVariable('image_fn_right')
            }
        };

        let left_or_right_screen = {
            type: 'audio-button-response',
            on_start: set_html_to_grey,
            stimulus: jsPsych.timelineVariable('sound_fn'),
            prompt: function() {
                
                var side = jsPsych.timelineVariable('side', true);
                
                console.log('side: ' + side);

                var grid = GRID_HTML_LEFT_RIGHT;
                if ( side === 0 ){
                    var newgrid = grid.replaceAll("./video/01_left",
                        jsPsych.timelineVariable('image_fn'));
                } else if (side === 1 ) {
                    var newgrid = grid.replaceAll("./video/03_right",
                        jsPsych.timelineVariable('image_fn'));
                    //console.log("OR screen gridright: ", newgrid)
                } else {
                    console.error("Stimulus side is unknown or undefined...");
                    var newgrid = 'error';
                }
                return newgrid;
            },
            response_ends_trial: false,
            trial_ends_after_audio: false,
            trial_duration: 1950,
            choices: [],
            on_finish: set_html_to_white,
            data: {
                target_audio: jsPsych.timelineVariable('sound_fn'),
                target_image: jsPsych.timelineVariable('image_fn'),
            }
        };


        let center_screen = {
            type: 'audio-button-response',
            on_start: set_html_to_grey,
            stimulus: jsPsych.timelineVariable('sound_fn'),
            prompt: function() {

                var grid = GRID_HTML_CENTER;
                    var grida = grid.replaceAll("./video/02_center",
                        jsPsych.timelineVariable('image_fn')
                        );

                    console.log("CENTER a: ", grida);
                    var newgrid = grida;
                return newgrid;
            },
            response_ends_trial: false,
            trial_ends_after_audio: false,
            trial_duration: 2450,
            choices: [],
            on_finish: set_html_to_white,
            data: {
                target_audio: jsPsych.timelineVariable('sound_fn'),
                target_image_a: jsPsych.timelineVariable('image_fn'),
            }
        };

        let qr_screen = {
            type: 'video-keyboard-response',
            on_start: set_html_to_white,
            stimulus: './video/qrcodes/qrspeed.webm',
            sources: [
                './video/qrcodes/qrspeed.webm',
                './video/qrcodes/qrspeed.mp4'
                ],
            prompt: "Press SPACEBAR?",
            response_ends_trial: false,
            trial_ends_after_video: false,
            controls: true,
            rate: 1,
            trial_duration: 2450,
            choices: jsPsych.ALL_KEYS,
            on_finish: set_html_to_grey,
            response_allowed_while_playing: true,
            autoplay: true
        };

        let binary_screen = {
            type: 'video-keyboard-response',
            on_start: set_html_to_grey,
            stimulus: './video/bincodes/256-bincodes.webm',
            sources: [
                './video/bincodes/256-bincodes.webm',
                './video/bincodes/256-bincodes.mp4'
                ],
            prompt: "Press SPACEBAR?",
            response_ends_trial: false,
            trial_ends_after_video: false,
            controls: true,
            rate: 1,
            trial_duration: 2450,
            choices: jsPsych.ALL_KEYS,
            on_finish: set_html_to_grey,
            response_allowed_while_playing: true,
            autoplay: true
        };

        let sync_screen = {
            type: 'audio-keyboard-response',
            on_start: set_html_to_white,
            stimulus: "./sounds/3.wav",
            prompt: "",
            response_ends_trial: false,
            trial_ends_after_audio: false,
            trial_duration: 450,
            choices: jsPsych.NO_KEYS,
            on_finish: set_html_to_grey
        };

        // PROCEDURES ////////////////////////////////

        let baseline_procedure = {
            timeline:[
                left_or_right_screen
                ],
            timeline_variables: baseline_items,
            randomize_order: false,
        };

        let paired_procedure = {
            timeline:[
                left_or_right_screen
                ],
            timeline_variables: paired_items,
            randomize_order: false,
        };

        let grabber_procedure_one = {
            timeline:[
                center_screen
                ],
            timeline_variables: grabber_items_one,
            randomize_order: false,
        };

        let grabber_procedure_two = {
            timeline:[
                center_screen
                ],
            timeline_variables: grabber_items_two,
            randomize_order: false,
        };

        /////////////////////////////////////////////


        let well_done_screen = {
            type: 'html-button-response',
            stimulus: function(){
                return "<div class='instruction' >" +
                    '<p>' + POST_REC_MESSAGE + '</p></div>';
            },
            choices: [OK_BUTTON_TEXT],
            response_ends_trial: true,
            data: { useful_data_flag: false }
        };

        let end_screen = {
            type: 'html-button-response',
            stimulus: DEBRIEF_MESSAGE,
            choices: [],
            trial_duration: DEBRIEF_MESSAGE_DURATION
        };

        // (timeline) procedures //////////////////////////////////////////////////////////        


        //////////////// timeline /////////////////////////////////

        let timeline = [];

        // it's best practice to have *mouse click* user I/O first
        timeline.push(start_screen);
        
        //timeline.push(qr_screen);
        //timeline.push(binary_screen);

        // Informed consent (consent.js)
        //timeline.push(consent_procedure);
        
        // survey
        //timeline.push(survey_procedure);

        //test/set audio level (soundtest.js)
        timeline.push(test_audio_looped);
        
        //timeline.push(instruction_screen_layout);

        timeline.push(check_screen_layout);

        // task instruction (instructions.js)
        timeline.push(instruction_screen_rec);

        // baseline
        timeline.push(baseline_procedure);

        timeline.push(sync_screen);

        // grabber one (again)
        timeline.push(grabber_procedure_one);

        // paired
        //timeline.push(paired_procedure);

        // grabber two
        //timeline.push(grabber_procedure_two);

        timeline.push(well_done_screen);
        
        timeline.push(end_screen);

        // Start jsPsych when running on a Desktop or Laptop style pc.
        if (! uil.isMobileOrTablet()) {
            jsPsych.init({
                timeline: timeline,
                preload_audio: [
                    check_audio,
                    baseline_audio,
                    paired_audio
                    ],
                preload_video: [
                    check_qrvideo,
                    bgvideo,
                    baseline_videos,
                    paired_videos,
                    grabber_video_one,
                    grabber_video_two
                    ],
                exclusions: {
                    min_width: MIN_WIDTH,
                    min_height: MIN_HEIGHT
                },
                on_finish: function() {
                    uil.saveData(ACCESS_KEY);
                }
            });
        }
        else { // or bail out.
            let paragraph = document.createElement("p")
            paragraph.innerHTML = BAIL_OUT_MOBILE_TEXT;
            document.body.appendChild(paragraph);
        }
    })
    </script>
</html>